<html style="overflow:hidden;height:100%;">
<head>
<title>打灰机</title>
<meta charset="utf-8"/>
<style>
*{
    padding:0;
    margin:0;
}
#scoreRecorder, #levelRecorder{
    color:white;
    font-size:50px;
}
body{
    background:url('pic/back.jpg') no-repeat;
    background-color:black;
}
.classPlane{
    position:absolute;
    display:none;    
    top:0;
}
#bombPlayer,#backPlayer,#errorPlayer{
    visibility:hidden;
    position:absolute;
}
#record{
    float:left;
}
#scoreRecorder,#levelRecorder{
    visibility:hidden;
}
#menu{   
    position:absolute;
    top:40%;
    width:100%;
    text-align:center;
}
#bloods{
    visibility:hidden;
}
#bloods img{
    float:right;
    width:50px;
}
#Introduction{
    position:absolute;
    top:15%;
    width:100%;
    text-align:center;
    font-size:40px;
    color:white;
}
button{ 
    border-radius:50%;
    background-color: yellow; /* Green */
    border: 5px solid grey;
    color: black;
    padding:15px;
    margin:15px;
    height:150px;
    width:200px;
    text-align: center;
    text-decoration: none;
    font-size: 40px;
}
button:active{
    background-color: black;
    color:white;
}
</style>
</head>
<body>
<audio id ="bombPlayer" src="sound/bomb.mp3" autostart=false></audio>
<audio id ="errorPlayer" src="sound/error.mp3" autostart=false></audio>
<audio id ="backPlayer" src="sound/back.mp3" autoplay="autoplay" loop></audio>
<div id="record">
    <div id="scoreRecorder">score:0</div>
    <div id="levelRecorder">level:0</div>
</div>
<div id="bloods">
    <img id="blood1" src="pic/blood.png"/>
    <img id="blood2" src="pic/blood.png"/>
    <img id="blood3" src="pic/blood.png"/>
</div>

<div id="Introduction">
游戏介绍</br>
只要打灰机就好啦</br>
药瓶可以加血</br>
玩的开心
</div>
<div id="menu">
     <button id="beginGame">开始游戏</button>
     <button id="shareGame">分享链接</button>
</div>
<script>
var DropArr = {};
var bloodImgArr = {};

var bombControl = document.getElementById("bombPlayer");
var errorControl = document.getElementById("errorPlayer");
var backControl = document.getElementById("backPlayer");

var dropTypes = ["blue","green","orange","grey","grey","pill"];
var iWidth = document.body.clientWidth;
var iHeight = document.body.clientHeight;
var scoreRecorder = document.getElementById("scoreRecorder");
var levelRecorder = document.getElementById("levelRecorder");
var level = 1;
var score = 0;
var arrSize = 50;
var planeClassName = "classPlane";
var planeWidthParam = 5;
var levelUpInterval = 10;
var currentBloods = 3;
var gameIntervalId;
function DropedThing(descripType){
    this.descripType = descripType;    
    this.running = false;
    this.animationID = -1;  
    
    this.element = document.createElement("img");
    this.element.className = planeClassName;
    this.element.src = "pic/" + descripType + ".png";
    this.element.width = iWidth / planeWidthParam;    
    this.element.style.top = 0;
    this.element.style.left = Math.random() * Math.floor(parseInt(iWidth, 10) * (1 - 1.0 / planeWidthParam));
    this.element.style.zIndex = descripType == "grey" ? "70" : "1"; 

    var that = this;
    this.element.onclick = function(){
        if(that.descripType === "grey"){
            ++score;                      
            if(score % levelUpInterval === 0){
                ++level;
                levelUpInterval *= level * 10;
            }
            bombControl.currentTime = 0;
            bombControl.play();
            scoreRecorder.innerHTML = "score:" + score;
            levelRecorder.innerHTML = "level:" + level;
            that.stopfly();
        }
        else if(that.descripType == "pill"){
            bombControl.currentTime = 0;
            bombControl.play();
            if(parseInt(currentBloods, 10) < 3){
                ++currentBloods;
                bloodImgArr[currentBloods].src = "pic/blood.png";
            }
            that.stopfly();
        }
        else{
            errorControl.currentTime = 0;
            errorControl.play();
            if(currentBloods == 0){
            console.log("Game Over");
            createDialog(score);
            //location.replace(window.location.href + "?t=" + Math.random() * 10); 
            }else{
                bloodImgArr[currentBloods].src = "pic/blooded.png";
                --currentBloods;
            }
        }
    };    
    return this;
}
DropedThing.prototype = {
    construcor: DropedThing,
    fly: function(){
        var updateSpeed = 1;
        this.running = true;
        this.element.style.display = "inline";     

        var that = this;
        var updatePosition = function(){
            var currentHeight = parseInt(that.element.style.top, 10);
            if(currentHeight < iHeight){ 
                that.element.style.top = (currentHeight + level) + "px";  
            }else{             
                that.stopfly();
                if(that.descripType == "grey"){ 
                    if(currentBloods == 0){
                        console.log("Game Over");
                        createDialog(score);
                        //location.replace(window.location.href + "?t=" + Math.random() * 10); 
                    }
                    else{
                        bloodImgArr[currentBloods].src = "pic/blooded.png";
                        --currentBloods;
                    }
                }
            }   
        };        
        this.animationID = setInterval(updatePosition,updateSpeed);
    },
    stopfly: function(){
        clearInterval(this.animationID);
        this.running = false;
        this.element.style.top = 0;
        this.element.style.display = "none";
    }    
}

document.getElementById("beginGame").addEventListener("click", function(){    
    var orignCreateInterval = 500;
    
    document.getElementById("scoreRecorder").style.visibility = "visible";
    document.getElementById("levelRecorder").style.visibility = "visible";
    document.getElementById("bloods").style.visibility = "visible";
    
    document.getElementById("beginGame").style.visibility = "hidden";
    document.getElementById("shareGame").style.visibility = "hidden";
    document.getElementById("Introduction").style.visibility = "hidden";
   
    gameIntervalId = setInterval(function(){
        var r = Math.floor(Math.random() * arrSize);
        if(DropArr[r].running != true)
            DropArr[r].fly();
    },orignCreateInterval / level);
    
});
function createDialog(point){
    var divBackground = document.createElement("div");
    var divDialog = document.createElement("div");    
    var divHead = document.createElement("div");    
    var divContent = document.createElement("div");    
    //Add background of dialog
    divBackground.style.position = "absolute";
    divBackground.style.background = "#000000";
    divBackground.style.width = "100%";
    divBackground.style.height = "100%";
    divBackground.style.left = "0px";
    divBackground.style.top = "0px";
    divBackground.style.zIndex = "99";
    divBackground.style.opacity = "0.6";    
    document.body.appendChild(divBackground);
    //ceate dialog
    var dialogHeight = 350;
    var dialogWidth = 400;
    divDialog.style.width = dialogWidth + "px";
    divDialog.style.height = dialogHeight + "px";        
    divDialog.style.position = "absolute";
    divDialog.style.border = "1px solid #C0D7FA";
    divDialog.style.borderRight = "2px outset #DEDEDE";
    divDialog.style.borderLeft = "2px outset #DEDEDE";
    divDialog.style.left = ((document.body.clientWidth / 2) - (dialogWidth / 2)) + "px";
    divDialog.style.top = (document.body.scrollTop + (document.body.clientHeight / 2) - (dialogHeight / 2)) + "px";
    divDialog.style.zIndex = "100";
    //create head
    divHead.appendChild(document.createTextNode("游戏结束"));
    divHead.style.width = "100%";
    divHead.style.height = "25px";
    divHead.style.lineHeight = "25px";
    divHead.style.fontSize = "14px";        
    divHead.style.fontWeight = "bold";
    divHead.style.borderBottom = "1px outset #8989FF";
    divHead.style.color = "white";
    divHead.style.textIndent = "10px";
    divHead.style.backgroundColor = "blue";
    divDialog.appendChild(divHead);
    //create content
    divContent.style.padding = "15px";
    divContent.style.fontSize = "50px";
    divContent.style.height = parseInt(dialogHeight - 55) + "px";
    divContent.style.backgroundColor = "#ffffff";
    divContent.style.textAlign = "center";
    divContent.innerHTML = "哎呀呀<br />游戏结束了" + "<br />最终得分:"+ point + "<br />";
    divDialog.appendChild(divContent);
    //create close button
    var closeButton = document.createElement("img");
    closeButton.style.cursor = "hand";
    closeButton.setAttribute("alt", "OK");
    closeButton.style.position = "absolute";
    closeButton.style.bottom = "10px";
    closeButton.style.width = "50%";
    closeButton.style.height = "20%";
    closeButton.style.left = "25%"
    closeButton.onclick = function() {
        location.replace(window.location.href + "?t=" + Math.random() * 10); 
    };
    divContent.appendChild(closeButton);
    divDialog.focus();       
    document.body.appendChild(divDialog);
    //Game over
    stopGame(gameIntervalId);
}
function stopGame(gameIntervalId){
    clearInterval(gameIntervalId);
    for(var i = 0 ; i < arrSize ; ++i){
        DropArr[i].stopfly();
    }
}
window.onload = function(){ 
    //createDialog(score);

    for(var i = 0 ; i < arrSize ; ++i){
        DropArr[i] = new DropedThing(dropTypes[Math.floor(Math.random() * dropTypes.length)]);
        document.body.appendChild(DropArr[i].element);
    }    
    for(var i = 1 ; i <= currentBloods ; ++i){
        bloodImgArr[i] = document.getElementById("blood"+i);
    } 
    
}
</script>
</body>
</html>