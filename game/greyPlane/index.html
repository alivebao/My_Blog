<html style="overflow:hidden;height:100%;">
<head>
<title>打灰机</title>
<meta charset="utf-8"/>
<style>
*{
    padding:0;
    margin:0;
}
#scoreRecorder, #levelRecorder{
    color:white;
    font-size:50px;
}
body{
    background:url('pic/back.jpg') no-repeat;
    background-color:black;
}
.classPlane{
    position:absolute;
    display:none;    
    top:0;
}
#bombPlayer,#backPlayer,#errorPlayer{
    visibility:hidden;
    position:absolute;
}
#record{
    float:left;
}
#scoreRecorder,#levelRecorder{
    visibility:hidden;
}
#menu{   
    position:absolute;
    top:40%;
    width:100%;
    text-align:center;
}
#bloods{
    visibility:hidden;
}
#bloods img{
    float:right;
    width:50px;
}
#Introduction{
    position:absolute;
    top:15%;
    width:100%;
    text-align:center;
    font-size:40px;
    color:white;
}
button{ 
    border-radius:50%;
    background-color: yellow; /* Green */
    border: 5px solid grey;
    color: black;
    padding:15px;
    margin:15px;
    height:150px;
    width:200px;
    text-align: center;
    text-decoration: none;
    font-size: 40px;
}
button:active{
    background-color: black;
    color:white;
}
</style>
</head>
<body>
<audio id ="bombPlayer" src="sound/bomb.mp3" autostart=false></audio>
<audio id ="errorPlayer" src="sound/error.mp3" autostart=false></audio>
<audio id ="backPlayer" src="sound/back.mp3" autoplay="autoplay" loop></audio>
<div id="record">
    <div id="scoreRecorder">score:0</div>
    <div id="levelRecorder">level:0</div>
</div>
<div id="bloods">
    <img id="blood1" src="pic/blood.png"/>
    <img id="blood2" src="pic/blood.png"/>
    <img id="blood3" src="pic/blood.png"/>
</div>

<div id="Introduction">
游戏介绍</br>
只要打灰机就好啦</br>
药瓶可以加血</br>
玩的开心
</div>
<table style="color:white;display:none;">
    <tr>
        <th>Month</th>
        <th>Savings</th>
    </tr>
    <tr>
        <td>January</td>
        <td>$100</td>
    </tr>
    <tr>
        <td>January</td>
        <td>$100</td>
    </tr>
</table>
<div id="menu">
     <button id="beginGame">开始游戏</button>
     <button id="shareGame">分享链接</button>
</div>
<script>
var DropArr = {};
var bloodImgArr = {};

var bombControl = document.getElementById("bombPlayer");
var errorControl = document.getElementById("errorPlayer");
var backControl = document.getElementById("backPlayer");

var dropTypes = ["blue","green","orange","grey","grey","pill"];
var iWidth = document.body.clientWidth;
var iHeight = document.body.clientHeight;
var scoreRecorder = document.getElementById("scoreRecorder");
var levelRecorder = document.getElementById("levelRecorder");
var level = 1;
var score = 0;
var arrSize = 50;
var planeClassName = "classPlane";
var planeWidthParam = 5;
var levelUpInterval = 10;
var currentBloods = 3;
var gameIntervalId;
function DropedThing(descripType){
    this.descripType = descripType;    
    this.running = false;
    this.animationID = -1;  
    
    this.element = document.createElement("img");
    this.element.className = planeClassName;
    this.element.src = "pic/" + descripType + ".png";
    this.element.width = iWidth / planeWidthParam;    
    this.element.style.top = 0;
    this.element.style.left = Math.random() * Math.floor(parseInt(iWidth, 10) * (1 - 1.0 / planeWidthParam));
    this.element.style.zIndex = descripType == "grey" ? "70" : "1"; 

    var that = this;
    this.element.onclick = function(){
        if(that.descripType === "grey"){
            ++score;                      
            if(score % levelUpInterval === 0){
                ++level;
                levelUpInterval *= level * 10;
            }
            bombControl.currentTime = 0;
            bombControl.play();
            scoreRecorder.innerHTML = "score:" + score;
            levelRecorder.innerHTML = "level:" + level;
            that.stopfly();
        }
        else if(that.descripType == "pill"){
            bombControl.currentTime = 0;
            bombControl.play();
            if(parseInt(currentBloods, 10) < 3){
                ++currentBloods;
                bloodImgArr[currentBloods].src = "pic/blood.png";
            }
            that.stopfly();
        }
        else{   
            errorControl.currentTime = 0;
            errorControl.play();
            if(currentBloods == 0){
            console.log("Game Over");
            (new GameDialog(score,false)).show();
            //location.replace(window.location.href + "?t=" + Math.random() * 10); 
            }else{
                bloodImgArr[currentBloods].src = "pic/blooded.png";
                --currentBloods;
            }
        }
    };    
    return this;
}
DropedThing.prototype = {
    construcor: DropedThing,
    fly: function(){
        var updateSpeed = 1;
        this.running = true;
        this.element.style.display = "inline";     

        var that = this;
        var updatePosition = function(){
            var currentHeight = parseInt(that.element.style.top, 10);
            if(currentHeight < iHeight){ 
                that.element.style.top = (currentHeight + level) + "px";  
            }else{             
                that.stopfly();
                if(that.descripType == "grey"){ 
                    if(currentBloods == 0){
                        console.log("Game Over");
                        (new GameDialog(score,false)).show();
                        //location.replace(window.location.href + "?t=" + Math.random() * 10); 
                    }
                    else{
                        bloodImgArr[currentBloods].src = "pic/blooded.png";
                        --currentBloods;
                    }
                }
            }   
        };        
        this.animationID = setInterval(updatePosition,updateSpeed);
    },
    stopfly: function(){
        clearInterval(this.animationID);
        this.running = false;
        this.element.style.top = 0;
        this.element.style.display = "none";
    }    
}

document.getElementById("beginGame").addEventListener("click", function(){    
    var orignCreateInterval = 500;
    
    document.getElementById("scoreRecorder").style.visibility = "visible";
    document.getElementById("levelRecorder").style.visibility = "visible";
    document.getElementById("bloods").style.visibility = "visible";
    
    document.getElementById("beginGame").style.visibility = "hidden";
    document.getElementById("shareGame").style.visibility = "hidden";
    document.getElementById("Introduction").style.visibility = "hidden";
   
    gameIntervalId = setInterval(function(){
        var r = Math.floor(Math.random() * arrSize);
        if(DropArr[r].descripType == "pill" && currentBloods == 3)
            return;
        if(DropArr[r].running != true)
            DropArr[r].fly();
    },orignCreateInterval / level);
    
});
function GameDialog(point,breakRecord){
    var dialogHeight = 350;
    var dialogWidth = 400;
    this.breakRecord = breakRecord;

    this.divBackground = document.createElement("div");
    this.divDialog = document.createElement("div");    
    this.divHead = document.createElement("div");    
    this.divContent = document.createElement("div");    
    this.closeButton = document.createElement("img");
    //Add background of dialog
    this.divBackground.style.position = "absolute";
    this.divBackground.style.background = "#000000";
    this.divBackground.style.width = "100%";
    this.divBackground.style.height = "100%";
    this.divBackground.style.left = "0px";
    this.divBackground.style.top = "0px";
    this.divBackground.style.zIndex = "99";
    this.divBackground.style.opacity = "0.6";  
    //ceate dialog    
    this.divDialog.style.width = dialogWidth + "px";
    this.divDialog.style.height = dialogHeight + "px";        
    this.divDialog.style.position = "absolute";
    this.divDialog.style.border = "1px solid #C0D7FA";
    this.divDialog.style.borderRight = "2px outset #DEDEDE";
    this.divDialog.style.borderLeft = "2px outset #DEDEDE";
    this.divDialog.style.left = ((document.body.clientWidth / 2) - (dialogWidth / 2)) + "px";
    this.divDialog.style.top = (document.body.scrollTop + (document.body.clientHeight / 2) - (dialogHeight / 2)) + "px";
    this.divDialog.style.zIndex = "100";
    //create head
    this.divHead.appendChild(document.createTextNode("游戏结束"));
    this.divHead.style.width = "100%";
    this.divHead.style.height = "25px";
    this.divHead.style.lineHeight = "25px";
    this.divHead.style.fontSize = "14px";        
    this.divHead.style.fontWeight = "bold";
    this.divHead.style.borderBottom = "1px outset #8989FF";
    this.divHead.style.color = "white";
    this.divHead.style.textIndent = "10px";
    this.divHead.style.backgroundColor = "blue";    
    //create content
    this.divContent.style.padding = "15px";
    this.divContent.style.fontSize = "50px";
    this.divContent.style.height = parseInt(dialogHeight - 55) + "px";
    this.divContent.style.backgroundColor = "#ffffff";
    this.divContent.style.textAlign = "center";
    this.divContent.innerHTML = "哎呀呀<br />游戏结束了<br />最终得分:"+ point + "<br />";    
    //check if add input 
    if(this.breakRecord){
        console.log("break record");
        this.divContent.innerHTML = "恭喜<br />破纪录了<br />最终得分:" + point +"<br />"
        this.divInputContainer = document.createElement("div");
        this.divHint = document.createElement("span");
        this.divHint.innerHTML = "姓名:"
        this.divHint.style.fontSize = "40px";
        
        this.divInput = document.createElement("input");
        this.divInput.setAttribute("placeholder", "无名氏");
        this.divInput.style.fontSize = "40px";
        this.divInput.style.width = "60%";
        
        this.divInputContainer.appendChild(this.divHint);
        this.divInputContainer.appendChild(this.divInput);
        
        this.divContent.appendChild(this.divInputContainer);
    }
    //create close button
    this.closeButton.style.cursor = "hand";
    this.closeButton.setAttribute("alt", "OK");
    this.closeButton.style.position = "absolute";
    this.closeButton.style.bottom = "10px";
    this.closeButton.style.width = "50%";
    this.closeButton.style.height = "20%";
    this.closeButton.style.left = "25%";
    var that = this;
    if(this.breakRecord){
        this.closeButton.onclick = function() {
            var inputName = that.divInput.value;
            if(!inputName)
                inputName = "无名氏";
            location.replace(window.location.href + "?t=" + Math.random() * 10); 
        }
    }
    else{
        that.closeButton.onclick = function() {
            location.replace(window.location.href + "?t=" + Math.random() * 10); 
        }
    };
//    stopGame(gameIntervalId);
}
GameDialog.prototype.show = function(){
    document.body.appendChild(this.divBackground);
    this.divDialog.appendChild(this.divHead);
    this.divContent.appendChild(this.closeButton);
    this.divDialog.appendChild(this.divContent);
    this.divDialog.focus();       
    document.body.appendChild(this.divDialog);
    
    stopGame(gameIntervalId);
}
function stopGame(gameIntervalId){
    clearInterval(gameIntervalId);
    for(var i = 0 ; i < arrSize ; ++i){
        DropArr[i].stopfly();
    }
}
window.onload = function(){ 
    backControl.volume = 0.1;
    for(var i = 0 ; i < arrSize ; ++i){
        DropArr[i] = new DropedThing(dropTypes[Math.floor(Math.random() * dropTypes.length)]);
        document.body.appendChild(DropArr[i].element);
    }    
    for(var i = 1 ; i <= currentBloods ; ++i){
        bloodImgArr[i] = document.getElementById("blood"+i);
    } 
   
}
</script>
</body>
</html>